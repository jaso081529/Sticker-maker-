<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HP67 Prompt2Sticker – Offline PWA (1080p • 300 DPI) – QR AUS</title>
<meta name="description" content="PWA: Offline Prompt→Sticker, 1080p Canvas, 300 DPI PNG, A3-Bogen, QR aus.">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0e0f12">
<style>
  :root{--bg:#0e0f12;--panel:#17191d;--panel2:#1d2127;--text:#e6e7ea;--muted:#9aa0a6;--accent:#4c8df6;--ok:#19c37d;--grid:#2a2f38}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #app{display:grid;grid-template-columns:320px 1fr 340px;grid-template-rows:auto 1fr auto;grid-template-areas:
      "head head head" "left center right" "foot foot foot";height:100%}
  header{grid-area:head;display:flex;gap:12px;align-items:center;padding:10px 14px;background:var(--panel);border-bottom:1px solid #222630}
  header h1{margin:0;font-size:16px}
  .pill{padding:4px 8px;border-radius:999px;background:#21252c;border:1px solid #2a2f38;color:#cbd1d8;font-size:12px}
  .btn{background:#22262f;color:#e6e7ea;border:1px solid #2f3642;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover{border-color:#3a4250}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#000}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .row label{width:120px;color:var(--muted);font-size:12px}
  .num{width:90px}
  .wide{width:100%}
  aside.left{grid-area:left;padding:10px;background:var(--panel);border-right:1px solid #222630;overflow:auto}
  aside.right{grid-area:right;padding:10px;background:var(--panel);border-left:1px solid #222630;overflow:auto}
  .section{background:var(--panel2);border:1px solid #2a2f38;border-radius:12px;padding:10px;margin-bottom:10px}
  .section h3{margin:0 0 8px 0;font-size:13px;color:#cbd1d8}
  main{grid-area:center;position:relative;overflow:auto;background:
    linear-gradient(90deg,transparent 49%,#1e232c 50%,transparent 51%) 0 0/40px 40px,
    linear-gradient(transparent 49%,#1e232c 50%,transparent 51%) 0 0/40px 40px;}
  #stageWrap{position:relative;display:flex;justify-content:center;align-items:center;min-height:100%;padding:20px}
  canvas#stage{background:#0b0c10;border:1px solid #2b313c}
  footer{grid-area:foot;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--panel);border-top:1px solid #222630;color:#9aa0a6}
  .tabbar{display:flex;gap:6px;margin-bottom:8px}
  .tab{padding:6px 10px;border:1px solid #2a2f38;border-radius:8px;background:#20242b;color:#cbd1d8;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .hint{font-size:12px;color:#98a0aa}
  input[type="color"]{width:42px;height:28px;border:0;background:transparent}
  input[type="range"]{width:100%}
</style>
</head>
<body>
<div id="app">
  <header>
    <img src="icons/icon-192.png" alt="" width="24" height="24" style="border-radius:6px">
    <h1>HP67 Prompt2Sticker – Offline</h1>
    <span class="pill">1080p Canvas</span>
    <span class="pill">PNG 300 DPI</span>
    <span class="pill">A3-Bogen</span>
    <span class="pill">QR: AUS</span>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button class="btn" id="btnNew">Neu</button>
      <button class="btn primary" id="btnGenerate">Generieren</button>
      <button class="btn" id="btnVari">Variante</button>
      <button class="btn ok" id="btnExportPNG">PNG</button>
      <button class="btn" id="btnPrint">PDF (Druck)</button>
      <button class="btn" id="btnInstall" title="Als App installieren">Installieren</button>
    </div>
  </header>

  <aside class="left">
    <div class="section">
      <h3>Prompt</h3>
      <div class="row"><label>Beschreibung</label><input class="wide" id="prompt" placeholder="z. B. ‚Teufel mit Schal und Megaphon, Flammen, bunte Farben‘"></div>
      <div class="row"><label>Stil</label>
        <select id="style" class="wide">
          <option>Karikatur Devil</option>
          <option>Graffiti Badge</option>
          <option>Comic Wappen</option>
        </select>
      </div>
      <div class="row"><label>Seed</label><input id="seed" class="num" type="number" value="0"><button class="btn" id="btnRand">Zufall</button></div>
      <div class="hint">100 % offline. Keine Uploads. Keine APIs.</div>
    </div>

    <div class="section">
      <h3>Farben</h3>
      <div class="row"><label>Primär</label><input type="color" id="c1" value="#ff1a1a"></div>
      <div class="row"><label>Sekundär</label><input type="color" id="c2" value="#111111"></div>
      <div class="row"><label>Akzent</label><input type="color" id="c3" value="#ffffff"></div>
      <div class="row"><label>Hintergrund</label><input type="color" id="bgc" value="#0a0a0a"></div>
      <div class="row"><label>Sättigung</label><input id="sat" type="range" min="0.6" max="1.8" step="0.01" value="1.25"></div>
      <div class="row"><label>Kontrast</label><input id="con" type="range" min="0.8" max="1.6" step="0.01" value="1.1"></div>
      <div class="row"><label>Outline</label><input id="olw" type="range" min="2" max="24" step="1" value="10"></div>
    </div>

    <div class="section">
      <h3>Export</h3>
      <div class="row"><label>Breite</label><input id="pxW" class="num" type="number" value="1920"> px</div>
      <div class="row"><label>Höhe</label><input id="pxH" class="num" type="number" value="1080"> px</div>
      <div class="row"><label>DPI-Tag</label><input id="dpi" class="num" type="number" value="300"> DPI</div>
      <div class="hint">PNG bekommt einen 300-DPI-pHYs-Tag. PDF via „Drucken“. A3-Bogen im rechten Panel.</div>
    </div>
  </aside>

  <main>
    <div id="stageWrap">
      <canvas id="stage" width="1920" height="1080"></canvas>
    </div>
  </main>

  <aside class="right">
    <div class="tabbar">
      <div class="tab active" data-tab="a3">A3-Bogen</div>
      <div class="tab" data-tab="fx">Feintuning</div>
      <div class="tab" data-tab="help">Hinweise</div>
    </div>

    <div class="section panel" id="panel-a3">
      <h3>A3-Druckbogen</h3>
      <div class="row"><label>Sticker-Breite</label><input id="stW" class="num" type="number" value="72"> mm</div>
      <div class="row"><label>Sticker-Höhe</label><input id="stH" class="num" type="number" value="102"> mm</div>
      <div class="row"><label>Untermaß</label><input id="underm" class="num" type="number" value="2.5"> %</div>
      <div class="row"><label>Abstand</label><input id="gap" class="num" type="number" value="3"> mm</div>
      <div class="row"><label>Ränder</label><input id="marg" class="num" type="number" value="6"> mm</div>
      <div class="row">
        <button class="btn" id="previewSheet">Vorschau</button>
        <button class="btn primary" id="downloadSheet">PNG A3</button>
        <button class="btn ok" id="printSheet">PDF (Druck)</button>
      </div>
      <div class="hint">A3: 297×420 mm = 3508×4961 px @ 300 DPI.</div>
    </div>

    <div class="section panel" id="panel-fx" style="display:none">
      <h3>Feintuning</h3>
      <div class="row"><label>Glanz/Glow</label><input id="glow" type="range" min="0" max="1" step="0.01" value="0.25"></div>
      <div class="row"><label>Unschärfe</label><input id="blur" type="range" min="0" max="2" step="0.05" value="0.15"></div>
      <div class="row"><label>Schärfen</label><input id="sharp" type="range" min="0" max="1.2" step="0.05" value="0.4"></div>
      <div class="hint">Anti-Grain: leichtes Weichzeichnen, dann dezentes Nachschärfen. Kein KI-Körnungseffekt.</div>
    </div>

    <div class="section panel" id="panel-help" style="display:none">
      <h3>Hinweise</h3>
      <ul>
        <li>App erzeugt Motive algorithmisch aus deinem Prompt. Keine Logos enthalten.</li>
        <li>PNG-Export mit 300 DPI, PDF über Druckdialog.</li>
        <li>A3-Bogen hat 2–3 % Untermaß für randlos-sicheren Druck.</li>
        <li>Offline-PWA: Manifest + Service Worker. Installation optional.</li>
      </ul>
    </div>
  </aside>

  <footer>
    <div>Status: <span id="status">Bereit</span></div>
    <div>Offline • sRGB • Keine QR-Codes</div>
  </footer>
</div>

<script>
// ===== PWA Install =====
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; });
document.getElementById('btnInstall').addEventListener('click', async()=>{
  if(!deferredPrompt){ alert('Installations-Prompt nicht verfügbar.'); return; }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
});

// SW registrieren
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

// ===== Utilities =====
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function mulberry32(a){ return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=(h*16777619)>>>0;} return h>>>0; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

function applyCanvasFilters(ctx, sat=1, con=1, blur=0){
  ctx.filter = `saturate(${sat}) contrast(${con}) blur(${blur}px)`;
}
function clearFilters(ctx){ ctx.filter='none'; }

// PNG pHYs DPI tag writer
function pngWithDPI(canvas, dpi){
  const dataUrl = canvas.toDataURL('image/png');
  const bin = atob(dataUrl.split(',')[1]);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  const ppm = Math.round(dpi/0.0254);
  const pHYs = new Uint8Array(4+4+4+9+4);
  const dv = new DataView(pHYs.buffer);
  dv.setUint32(0, 9);
  pHYs.set([112,72,89,115], 4);
  dv.setUint32(8, ppm);
  dv.setUint32(12, ppm);
  pHYs[16]=1;
  function crc32(arr){ let c=~0; for(let i=0;i<arr.length;i++){ c^=arr[i]; for(let k=0;k<8;k++) c=(c>>>1) ^ (0xEDB88320 & -(c & 1)); } return ~c>>>0; }
  const typeAndData = pHYs.slice(4, 17);
  const crc = crc32(typeAndData);
  dv.setUint32(17, crc);
  const sig=8, ihdrTotal=25, insertAt=sig+ihdrTotal;
  const out = new Uint8Array(bytes.length + pHYs.length);
  out.set(bytes.slice(0, insertAt), 0);
  out.set(pHYs, insertAt);
  out.set(bytes.slice(insertAt), insertAt + pHYs.length);
  return new Blob([out], {type:'image/png'});
}

// ===== Canvas + Drawing =====
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d');

function resizeCanvas(w,h){ canvas.width=w; canvas.height=h; }

function generate(){
  const cfg = cfgFromUI();
  const w = parseInt(document.getElementById('pxW').value,10);
  const h = parseInt(document.getElementById('pxH').value,10);
  resizeCanvas(w,h);
  drawSticker(cfg);
  document.getElementById('status').textContent = `Generiert • Seed ${cfg.seed}`;
}

function cfgFromUI(){
  const prompt = document.getElementById('prompt').value.trim();
  let seed = parseInt(document.getElementById('seed').value||'0',10);
  if(!seed||Number.isNaN(seed)){ seed = hashStr(prompt || Date.now().toString()); document.getElementById('seed').value = seed; }
  return {
    prompt,
    style: document.getElementById('style').value,
    seed,
    col: paletteFromPrompt(prompt, document.getElementById('c1').value, document.getElementById('c2').value, document.getElementById('c3').value),
    sat: parseFloat(document.getElementById('sat').value),
    con: parseFloat(document.getElementById('con').value),
    outline: parseInt(document.getElementById('olw').value,10),
    bgc: document.getElementById('bgc').value,
    fx: { glow: parseFloat(document.getElementById('glow').value), blur: parseFloat(document.getElementById('blur').value), sharp: parseFloat(document.getElementById('sharp').value) }
  };
}

document.getElementById('btnGenerate').addEventListener('click', generate);
document.getElementById('btnVari').addEventListener('click', ()=>{ document.getElementById('seed').value = (parseInt(document.getElementById('seed').value||'0',10)+1)>>>0; generate(); });
document.getElementById('btnRand').addEventListener('click', ()=>{ document.getElementById('seed').value = (Math.random()*0xffffffff)>>>0; });
document.getElementById('btnNew').addEventListener('click', ()=>{ document.getElementById('prompt').value=''; document.getElementById('seed').value='0'; generate(); });

document.getElementById('btnExportPNG').addEventListener('click', ()=>{
  const dpi = parseInt(document.getElementById('dpi').value,10)||300;
  const blob = pngWithDPI(canvas, dpi);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `sticker_${dpi}dpi.png`;
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('btnPrint').addEventListener('click', ()=>{
  const w = window.open('', '_blank');
  const data = canvas.toDataURL('image/png');
  w.document.write(`<html><head><title>Print</title><style>body{margin:0} img{width:100%;height:auto;display:block}</style></head><body><img src="${data}"></body></html>`);
  w.document.close(); w.focus(); w.print();
});

// ===== Drawing primitives =====
function paletteFromPrompt(p, c1, c2, c3){
  p = (p||'').toLowerCase();
  const red = c1 || '#ff1a1a';
  const dark = c2 || '#111111';
  const white = c3 || '#ffffff';
  if(p.includes('waldhof')||p.includes('mannheim')) return [red, dark, white];
  if(p.includes('gold')) return ['#ffcc00', '#111111', '#ffffff'];
  if(p.includes('gift')||p.includes('neon')) return ['#39ff14', '#111111', '#ffffff'];
  if(p.includes('blau')) return ['#1a7cff', '#0a0f1a', '#ffffff'];
  return [red, dark, white];
}
function pickSlogan(p, seed){
  const base = ['RED DEVILS','BETZE POWER','DIVISION 67','HOODPLAKA'];
  const neg = ['KEIN WALDHOF','K-TOWN ONLY','LAUTERN ÜBER ALLES'];
  const h = (seed%2===0) ? base[(seed>>>1)%base.length] : neg[(seed>>>1)%neg.length];
  const extra = (p||'').toUpperCase().split(/\W+/).filter(w=>w.length>3)[0];
  return extra ? `${h} · ${extra}` : h;
}

function drawSticker(cfg){
  const {seed, prompt, col, sat, con, outline, bgc, fx} = cfg;
  const rand = mulberry32(seed);
  // Background
  ctx.save();
  ctx.fillStyle = bgc; ctx.fillRect(0,0,canvas.width, canvas.height);
  const g = ctx.createRadialGradient(canvas.width*0.5, canvas.height*0.55, Math.min(canvas.width,canvas.height)*0.1,
                                     canvas.width*0.5, canvas.height*0.5, Math.max(canvas.width,canvas.height)*0.65);
  g.addColorStop(0, adjustSat(col[1], 0.5));
  g.addColorStop(1, darken(adjustSat(col[1], 0.8), 0.25));
  ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);

  // burst lines
  const lines = 24; ctx.globalAlpha = 0.12; ctx.translate(canvas.width/2, canvas.height/2);
  for(let i=0;i<lines;i++){
    const ang = (i/lines)*Math.PI*2 + rand()*0.05;
    const r1 = Math.min(canvas.width,canvas.height)*0.05;
    const r2 = Math.max(canvas.width,canvas.height)*0.55;
    ctx.beginPath(); ctx.moveTo(Math.cos(ang)*r1, Math.sin(ang)*r1); ctx.lineTo(Math.cos(ang)*r2, Math.sin(ang)*r2);
    ctx.lineWidth = 10; ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.stroke();
  }
  ctx.setTransform(1,0,0,1,0,0); ctx.globalAlpha = 1;

  // rings
  const cx = canvas.width/2, cy = canvas.height/2;
  const R = Math.min(canvas.width,canvas.height)*0.38;
  ring(cx, cy, R*1.02, outline, col[2], col[0]);
  ring(cx, cy, R*0.86, Math.max(2, outline*0.6), '#ffffff', col[1]);

  // mascot
  const mx = cx, my = cy*0.9;
  drawDevilMascot(mx, my, R*0.95, col, outline, seed);

  // arc text
  const slogan = pickSlogan(prompt, seed);
  drawArcText(slogan.toUpperCase(), cx, cy*1.78, R*0.95, outline, col);

  // FX
  applyCanvasFilters(ctx, sat, con, 0);
  if(fx.blur>0){ ctx.filter = `blur(${fx.blur}px)`; const snap = snapshot(); ctx.filter='none'; ctx.drawImage(snap,0,0); }
  if(fx.glow>0){ glowPass(fx.glow); }
  if(fx.sharp>0){ unsharpMask(fx.sharp); }
  clearFilters(ctx);
}

function adjustSat(hex, factor){ const {h,s,l}=rgb2hsl(hex2rgb(hex)); return hsl2hex({h,s: clamp(s*factor,0,1), l}); }
function darken(hex, amt){ const {r,g,b}=hex2rgb(hex); return rgb2hex({r:Math.round(r*(1-amt)), g:Math.round(g*(1-amt)), b:Math.round(b*(1-amt))}); }
function lighten(hex, amt){ const {r,g,b}=hex2rgb(hex); const L=v=>clamp(Math.round(v*(1+amt)),0,255); return rgb2hex({r:L(r),g:L(g),b:L(b)}); }

function ring(x,y,r, w, color, stroke){
  ctx.save(); ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.lineWidth=w; ctx.strokeStyle=color; ctx.stroke();
  if(stroke){ ctx.lineWidth=Math.max(2, w*0.35); ctx.strokeStyle=stroke; ctx.stroke(); } ctx.restore();
}

function pathEllipse(x,y,w,h, rot, fill, outline, outlineColor){
  ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
  ctx.beginPath(); ctx.ellipse(0,0,w/2,h/2,0,0,Math.PI*2);
  ctx.fillStyle=fill; ctx.fill(); ctx.lineWidth=outline; ctx.strokeStyle=outlineColor; ctx.stroke(); ctx.restore();
}
function eye(x,y,r, col, outline){
  ctx.save(); ctx.translate(x,y);
  ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  ctx.lineWidth=Math.max(2, outline*0.4); ctx.strokeStyle=col; ctx.stroke();
  ctx.beginPath(); ctx.arc(-r*0.25,-r*0.2,r*0.25,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.fill(); ctx.restore();
}
function mouth(x,y,w,h, col, outline){
  ctx.save(); ctx.translate(x,y); ctx.beginPath(); ctx.ellipse(0,0,w/2,h/2,0,0,Math.PI);
  ctx.lineWidth=Math.max(4, outline*0.5); ctx.strokeStyle=col; ctx.stroke();
  const t=6; for(let i=0;i<t;i++){ const px=-w/2+(i+0.5)*(w/t); ctx.fillStyle='#fff'; ctx.fillRect(px-(w/t)*0.2,-1,(w/t)*0.4,h*0.35); }
  ctx.restore();
}
function horn(x,y,S, dir, fill, outline){
  ctx.save(); ctx.translate(x,y); ctx.rotate(dir);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(S*0.05,-S*0.25, S*0.45,-S*0.95); ctx.quadraticCurveTo(S*0.10,-S*0.45, 0,-S*0.05);
  ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); ctx.lineWidth=outline; ctx.strokeStyle='#fff'; ctx.stroke(); ctx.restore();
}
function scarf(x,y,w,h, base, stripe, outline){
  ctx.save(); ctx.translate(x,y); roundedRect(-w/2,-h/2,w,h,h*0.45, base, outline, '#fff');
  const bands=5; for(let i=0;i<bands;i++){ ctx.fillStyle=stripe; const bw=w/(bands*2); ctx.fillRect(-w/2+i*bw*2+bw*0.2, -h/2+2, bw*1.2, h-4); }
  ctx.restore();
}
function roundedRect(x,y,w,h,r, fill, outline, ocol){
  ctx.save(); ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath(); ctx.fillStyle=fill; ctx.fill(); ctx.lineWidth=outline; ctx.strokeStyle=ocol; ctx.stroke(); ctx.restore();
}
function megaphone(x,y,S, col, prim, outline){
  ctx.save(); ctx.translate(x,y); ctx.rotate(-0.25);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(S*0.75,-S*0.18); ctx.lineTo(S*0.75,S*0.18); ctx.closePath(); ctx.fillStyle=col; ctx.fill();
  ctx.lineWidth=outline; ctx.strokeStyle='#fff'; ctx.stroke();
  roundedRect(-S*0.08, S*0.05, S*0.18, S*0.42, S*0.08, prim, Math.max(2, outline*0.5), '#fff');
  ctx.strokeStyle=col; ctx.lineWidth=Math.max(2, outline*0.35);
  for(let i=1;i<=3;i++){ ctx.beginPath(); ctx.arc(S*0.90,0,S*0.20*i,-0.4,0.4); ctx.stroke(); }
  ctx.restore();
}
function flamesBelow(x,y,S, col, outline){
  ctx.save(); ctx.translate(x,y); const n=8;
  for(let i=0;i<n;i++){ const ang=(i/n-0.5)*Math.PI; const h=S*(0.35+0.4*Math.random());
    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(Math.cos(ang)*h*0.2, -h*0.2, Math.cos(ang)*h*0.1, -h);
    ctx.quadraticCurveTo(-Math.cos(ang)*h*0.1, -h*0.5, 0,0);
    ctx.fillStyle = i%2 ? lighten(col,0.15) : col; ctx.globalAlpha=0.85; ctx.fill(); ctx.globalAlpha=1; }
  ctx.restore();
}
function drawDevilMascot(x,y,S, col, outline, seed){
  const rnd = mulberry32(seed+123);
  ctx.save(); ctx.translate(x,y);
  const bodyW=S*0.80, bodyH=S*0.62;
  pathEllipse(0,0, bodyW, bodyH, 0, col[0], outline, col[2]);
  const eyeDx=bodyW*0.18, eyeDy=-bodyH*0.1, eyeR=bodyH*0.09;
  eye(-eyeDx, eyeDy, eyeR, col[2], outline); eye(+eyeDx, eyeDy, eyeR, col[2], outline);
  mouth(0, bodyH*0.12, bodyW*0.42, bodyH*0.22, col[2], outline);
  horn(-bodyW*0.28, -bodyH*0.42, S*0.28, -0.9, col[0], outline);
  horn(+bodyW*0.28, -bodyH*0.42, S*0.28, +0.9, col[0], outline);
  scarf(0, bodyH*0.28, bodyW*0.9, bodyH*0.22, col[0], col[1], outline);
  if((seed%3)===0){ megaphone(bodyW*0.55, -bodyH*0.05, S*0.38, col[2], col[0], outline); }
  else { flamesBelow(0, bodyH*0.45, S*0.9, col[0], outline); }
  ctx.restore();
}

// Arc text
function drawArcText(text, cx, cy, radius, outline, col){
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(Math.PI);
  const chars=[...text]; const baseSize=Math.round(radius*0.12); let angle=Math.PI*0.95;
  for(const ch of chars){
    ctx.save(); ctx.rotate(angle); ctx.translate(0, -radius*0.02);
    ctx.font=`900 ${baseSize}px Impact, Arial Black, system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.lineWidth=Math.max(2, outline*0.6); ctx.strokeStyle=col[2]; ctx.fillStyle=col[0];
    ctx.strokeText(ch, 0, -radius); ctx.fillText(ch, 0, -radius);
    ctx.restore();
    angle -= 1.1 * (Math.PI*2 / Math.max(24, chars.length*2.2));
  }
  ctx.restore();
}

// FX helpers
function snapshot(){ const c=document.createElement('canvas'); c.width=canvas.width; c.height=canvas.height; c.getContext('2d').drawImage(canvas,0,0); return c; }
function glowPass(amount){
  const snap = snapshot();
  const tmp = document.createElement('canvas'); tmp.width=canvas.width; tmp.height=canvas.height;
  const tctx = tmp.getContext('2d'); tctx.filter = `blur(${4*amount}px)`; tctx.drawImage(snap,0,0);
  ctx.globalCompositeOperation='lighter'; ctx.globalAlpha = 0.55*amount; ctx.drawImage(tmp,0,0); ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
}
function unsharpMask(strength){
  const snap = snapshot();
  const t = document.createElement('canvas'); t.width=canvas.width; t.height=canvas.height;
  const tx = t.getContext('2d'); tx.filter='blur(1.2px)'; tx.drawImage(snap,0,0);
  ctx.globalCompositeOperation='overlay'; ctx.globalAlpha = 0.6*strength; ctx.drawImage(snap,0,0); ctx.globalCompositeOperation='source-over'; ctx.globalAlpha=1;
}

// Color helpers
function hex2rgb(hex){ hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const num=parseInt(hex,16); return {r:(num>>16)&255, g:(num>>8)&255, b:num&255}; }
function rgb2hex({r,g,b}){ const s=n=>n.toString(16).padStart(2,'0'); return '#'+s(r)+s(g)+s(b); }
function rgb2hsl({r,g,b}){
  r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2;
  if(max===min){h=s=0;} else{ const d=max-min; s=l>0.5? d/(2-max-min) : d/(max+min);
    switch(max){ case r: h=(g-b)/d + (g<b?6:0); break; case g: h=(b-r)/d + 2; break; case b: h=(r-g)/d + 4; break; } h/=6; }
  return {h:Math.round(h*360), s, l};
}
function hsl2hex({h,s,l}){
  s=clamp(s,0,1); l=clamp(l,0,1); const a=s*Math.min(l,1-l);
  const f=n=>{ const k=(n+h/30)%12; const c=l-a*Math.max(-1,Math.min(k-3, Math.min(9-k, 1))); return Math.round(255*c); };
  return rgb2hex({r:f(0),g:f(8),b:f(4)});
}

// A3 sheet
function buildA3Sheet(stickerCanvas, mmW, mmH, underm, gap, marg){
  const DPI=300, pxW=3508, pxH=4961;
  const sheet=document.createElement('canvas'); sheet.width=pxW; sheet.height=pxH;
  const sx=sheet.getContext('2d'); sx.fillStyle='#fff'; sx.fillRect(0,0,pxW,pxH);
  const scale = DPI/25.4;
  const w = Math.round(mmW*scale*(1 - underm/100));
  const h = Math.round(mmH*scale*(1 - underm/100));
  const g = Math.round(gap*scale);
  const m = Math.round(marg*scale);
  let x=m, y=m;
  while(y + h + m <= pxH){
    while(x + w + m <= pxW){
      sx.drawImage(stickerCanvas, 0,0, stickerCanvas.width, stickerCanvas.height, x, y, w, h);
      sx.strokeStyle='#000'; sx.lineWidth=1; sx.beginPath();
      sx.moveTo(x, y-6); sx.lineTo(x, y+6);
      sx.moveTo(x+w, y-6); sx.lineTo(x+w, y+6);
      sx.moveTo(x-6, y); sx.lineTo(x+6, y);
      sx.moveTo(x-6, y+h); sx.lineTo(x+6, y+h);
      sx.stroke();
      x += w + g;
    }
    x = m; y += h + g;
  }
  return sheet;
}

// UI tabs
$$('.tab').forEach(t=>t.addEventListener('click', e=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const which=t.dataset.tab; $$('.panel').forEach(p=>p.style.display='none'); document.getElementById('panel-'+which).style.display='block';
}));

// Hook sheet buttons
document.getElementById('previewSheet').addEventListener('click', ()=>{
  const c = buildA3Sheet(canvas,
    parseFloat(document.getElementById('stW').value), parseFloat(document.getElementById('stH').value),
    parseFloat(document.getElementById('underm').value), parseFloat(document.getElementById('gap').value), parseFloat(document.getElementById('marg').value));
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>A3 Vorschau</title><style>body{margin:0;background:#333} img{width:100%;height:auto;display:block}</style></head><body><img src="${c.toDataURL('image/png')}"></body></html>`);
  w.document.close();
});
document.getElementById('downloadSheet').addEventListener('click', ()=>{
  const c = buildA3Sheet(canvas,
    parseFloat(document.getElementById('stW').value), parseFloat(document.getElementById('stH').value),
    parseFloat(document.getElementById('underm').value), parseFloat(document.getElementById('gap').value), parseFloat(document.getElementById('marg').value));
  const a = document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='A3_Sheet_300dpi.png'; a.click();
});
document.getElementById('printSheet').addEventListener('click', ()=>{
  const c = buildA3Sheet(canvas,
    parseFloat(document.getElementById('stW').value), parseFloat(document.getElementById('stH').value),
    parseFloat(document.getElementById('underm').value), parseFloat(document.getElementById('gap').value), parseFloat(document.getElementById('marg').value));
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print A3</title><style>body{margin:0} img{width:100%;height:auto;display:block}</style></head><body><img src="${c.toDataURL('image/png')}"></body></html>`);
  w.document.close(); w.focus(); w.print();
});

// Initial
window.addEventListener('load', generate);
</script>
</body>
</html>
